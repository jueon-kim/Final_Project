<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>글목록</title>
    <style>
        .chatButton{
            width: 300px;
            height: 40px;
            margin: 12px 0 0 120px;
            border: 1px solid #FF7A6B;
            border-radius: 10px;
            text-align: center;
            padding: 7px;
            color: black;
            background-color: white;
            cursor: pointer;
        }
        .chatButton:hover{
            color: white;
            background-color: #FF7A6B;
            border-color: #FF7A6B;
            cursor: pointer;
        }
        .chatButton:hover a{
            color: white;
            background-color: #FF7A6B;
            border-color: #FF7A6B;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div th:include="/views/header.html"></div>

<section style="width: 1400px; margin: auto; justify-content: center" th:each="detail : ${postDetail}">

        <div style="width: 100%; height: 500px;">

            <div th:if="${detail.post_saleState == '판매중'}" style="width: 700px; height: 500px; float: left; border-radius: 15px;">
                <div id="carouselExampleRide" class="carousel slide" data-bs-ride="true">
                    <div class="carousel-inner">

                        <div class="carousel-item active">
                            <img src="https://media.bunjang.co.kr/images/nocrop/1105059583_w1197.jpg" class="sc-eMigcr fVUxsR" alt="">
                        </div>

                        <div class="carousel-item">
                            <img src="https://media.bunjang.co.kr/images/nocrop/1103044842_w1197.jpg" class="sc-eMigcr fVUxsR" alt="">
                        </div>

                        <div class="carousel-item">
                            <img src="https://media.bunjang.co.kr/images/nocrop/1103490943_w1197.jpg" class="sc-eMigcr fVUxsR" alt="">
                        </div>

                        <div class="carousel-item">
                            <img src="https://media.bunjang.co.kr/images/nocrop/1103485261_w1197.jpg" class="sc-eMigcr fVUxsR" alt="">
                        </div>

                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleRide" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>

                    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleRide" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>

            <div th:if="${detail.post_saleState == '예약중'}" style="width: 700px; height: 500px; float: left; border-radius: 15px;">
                <img th:src="@{|/upload/${detail.file_url}|}" style="width: 50px; height: 50px; border-radius: 100%">&nbsp;&nbsp;<span th:text="${session.user.user_nick}"></span>
                <div style="width: 700px; height: 500px; background-image: url('/img/default.png'); background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 15px;">
                    <div style="width: 700px; height: 500px; text-align: center; padding: 130px; background-color: rgba(0, 0, 0, 0.7); color:white; border-radius: 15px;">
                        <i class="bi bi-check-circle" style="font-size: 100px;"></i><br>
                        <span style="font-size: 40px;">예약중</span>
                    </div>
                </div>
            </div>

            <div th:if="${detail.post_saleState == '판매완료'}" style="width: 700px; height: 500px; float: left; border-radius: 15px;">
                <div style="width: 700px; height: 500px; background-image: url('/img/default.png'); background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 15px;">
                    <div style="width: 700px; height: 500px; text-align: center; padding: 130px; background-color: rgba(0, 0, 0, 0.7); color:white; border-radius: 15px;">
                        <i class="bi bi-check-circle" style="font-size: 100px;"></i><br>
                        <span style="font-size: 40px;">판매완료</span>
                    </div>
                </div>
            </div>

            <div style="width: 640px; height: 500px; float: right;">
                <div style="width: 604px; margin: auto;">
                    <span>홈</span> > <span th:text="${detail.getCategoryName()}"></span>
                </div><br>

                <div style="width: 604px; height:200px; margin: auto;">
                    <h1 th:text="${detail.post_title}"></h1>
                    <p style="font-size: 30px;" th:text="${detail.post_price} +'원' "></p>
                </div>

                <div style="width: 604px; margin: auto; color: gray" th:if="${detail.post_update != null}">
                    <span id="regdate" th:text="${detail.post_update}"></span> · 조회 <span th:text="${detail.post_hits}"></span> · <span>찜 0</span>
                </div>

                <div style="width: 604px; margin: auto; color: gray" th:if="${detail.post_update == null}">
                    <span id="regdate" th:text="${detail.post_regdate}"></span> · 조회 <span th:text="${detail.post_hits}"></span> · <span>찜 0</span>
                </div>

                <div style="display: flex; font-size: 20px; text-align: center; width: 604px; height:100px; margin: auto;">
                    <div style="margin: 25px 20px 0 20px;">
                        <span>제품상태</span><br>
                        <span style="color: #FF7A6B; font-weight: 700;" th:text="${detail.post_productState}"></span>
                    </div>
                    <div style="margin: 25px 20px 0 20px;">
                        <span>거래방식</span><br>
                        <span style="color: #FF7A6B; font-weight: 700;" th:text="${detail.post_way}"></span>
                    </div>
                    <div style="margin: 25px 20px 0 20px; cursor: pointer" id="locationView">
                        <span>거래지역</span><br>
                        <span style="color: #FF7A6B; font-weight: 700;" th:text="${detail.post_location2}"></span>
                        <input id="location" type="hidden" th:value="${detail.post_location}">
                    </div>
                    <div style="margin: 25px 20px 0 20px;">
                        <span>판매상태</span><br>
                        <span style="color: #FF7A6B; font-weight: 700;" th:text="${detail.post_saleState}"></span>
                    </div>
                </div>
                <div id="map" style="width:560px; height:400px; position: absolute; z-index: 20; display: none"></div>

                <div>
                    <div th:if="${detail.post_saleState == '판매중'}" style="width: 604px; margin: auto; padding: 20px;">
                        <i th:if="${like.likeNum==0}" th:attr="post_num=${detail.post_num}" style="font-size: 40px; float: left; color: #FF7A6B" class="bi bi-heart iconHeart"></i>
                        <i th:unless="${like.likeNum==0}" th:attr="post_num=${detail.post_num}" style="font-size: 40px; float: left; color: #FF7A6B" class="bi bi-heart-fill iconHeart"></i>
                            <a id="link" th:href="@{/chat/{userNum}(userNum=${detail.user_num})}">
                                <div class="chatButton" id="chatButton">채팅하기</div>
                            </a>
                    </div>
                    <div id="edit" th:if="${detail.post_saleState == '예약중'}" style="width: 604px; margin: auto; padding: 20px;" disabled>
                        <i th:if="${like.likeNum==0}" th:attr="post_num=${detail.post_num}" style="font-size: 40px; float: left; color: #FF7A6B" class="bi bi-heart iconHeart"></i>
                        <i th:unless="${like.likeNum==0}" th:attr="post_num=${detail.post_num}" style="font-size: 40px; float: left; color: #FF7A6B" class="bi bi-heart-fill iconHeart"></i>
                            <a id="link" th:href="@{/chat/{userNum}(userNum=${detail.user_num})}">
                                <div class="chatButton" id="chatButton">채팅하기</div>
                            </a>
                    </div>
                    <div id="edit" th:if="${detail.post_saleState == '판매완료'}" style="width: 604px; margin: auto; padding: 20px;" disabled>
                        <i th:if="${like.likeNum==0}" th:attr="post_num=${detail.post_num}" style="font-size: 40px; float: left; color: #FF7A6B" class="bi bi-heart iconHeart"></i>
                        <i th:unless="${like.likeNum==0}" th:attr="post_num=${detail.post_num}" style="font-size: 40px; float: left; color: #FF7A6B" class="bi bi-heart-fill iconHeart"></i>
                            <a id="link" th:href="@{/chat/{userNum}(userNum=${detail.user_num})}">
                                <div class="chatButton" id="chatButton">채팅하기</div>
                            </a>
                    </div>
                </div>
            </div>
        </div> <br><br><br><br>

        <div style="width: 1200px; height: auto; margin: auto; font-size: 20px;">
            상품정보
            <hr>
            <div th:text="${detail.post_content}">

            </div>
        </div>
</section>

<script th:inline="javascript">
    var likeIcons = document.getElementsByClassName('iconHeart');

    document.addEventListener('DOMContentLoaded', function () {
        Array.from(likeIcons).forEach(function(icon) {
            icon.addEventListener('click', function (){
                const postNum = this.getAttribute('post_num');
                console.log("postNum : " + postNum);
                $.ajax({
                    type: "post",
                    url: "/like",
                    data: {
                        "postNum": postNum
                    },
                    success: (res) => {
                        console.log("res.postNum : " + res.postNum);
                        console.log("res.userNum : " + res.userNum);
                        console.log("res.likeNum : " + res.likeNum);

                        let isLiked = res.likeNum;
                        if (isLiked === 0) {
                            this.className = "bi bi-heart"; // `this`는 클릭된 아이콘을 참조합니다.
                        } else {
                            this.className = "bi bi-heart-fill";
                        }
                    },
                    error: function (err) {
                        console.log(err)
                    }
                });
            })
        });
    })
</script>

<script>
    function formatDate(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const diff = now - date;
        const minutes = Math.floor(diff / (1000 * 60));
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const months = Math.floor(diff / (1000 * 60 * 60 * 24 * 30));
        const years = Math.floor(diff / (1000 * 60 * 60 * 24 * 30 * 12));

        if (minutes < 60) {
            return minutes + '분 전';
        } else if (hours < 24) {
            return hours + '시간 전';
        } else if (days < 30) {
            return days + '일 전';
        } else if (months < 12){
            return months + '달 전';
        } else {
            return years + '년 전';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const regdateElements = document.querySelectorAll('#regdate');

        regdateElements.forEach(function(element) {
            var regdate = element.textContent;
            // 날짜 형식 변환 함수 호출
            var formattedDate = formatDate(regdate);
            element.textContent = formattedDate;
        });
    });
</script>



<script>
    // 페이지 로드 시 initMap 함수 실행
    window.onload = function () {
        initializeMap();
    };
    // 지도 관련 함수
    var map; // 지도 객체를 저장하는 변수
    var marker; // 마커 객체를 저장하는 변수

    // 주소를 검색하여 지도에 표시하는 함수
    function initializeMap() {
        var addr = document.getElementById('location').value; // 입력된 주소 가져오기
        var geocoder = new kakao.maps.services.Geocoder(); // 주소 검색 객체 생성


        // 주소 검색 요청
        geocoder.addressSearch(addr, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
                // 검색된 주소의 좌표로 지도 초기화
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                // 지도 옵션 설정
                var mapContainer = document.getElementById('map');
                var mapOptions = {
                    center: coords, // 지도 중심 좌표 설정
                    level: 5// 지도 확대 수준 설정
                };
                // 지도 객체 생성
                map = new kakao.maps.Map(mapContainer, mapOptions);

                // 새로운 마커 생성
                marker = new kakao.maps.Marker({
                    position: coords,
                    map: map
                });
            }
        });
    }


    document.addEventListener('DOMContentLoaded', function () {
        const locationView = document.getElementById('locationView');
        const map = document.getElementById('map');

        // 마우스가 지도 요소 위로 올라갔을 때
        locationView.addEventListener('mouseover', function() {
            initializeMap();
            map.style.display = 'block';
        });


        // 마우스가 지도 요소를 벗어났을 때
        map.addEventListener('mouseleave', function() {
            initializeMap();
            map.style.display = 'none';
        });
    });

</script>



<script th:inline="javascript">
    /*<![CDATA[*/
    var sessionInfo = /*[[${session.user}]]*/ {};
    /*]]>*/
    console.log("세션정보 : "+sessionInfo);

    /*<![CDATA[*/
    var postInfo = /*[[${postDetail}]]*/ {};
    /*]]>*/
    console.log("게시물 정보 : "+postInfo);

    var editButtons = document.getElementById('chatButton').innerText;
    console.log(editButtons);


    document.addEventListener('DOMContentLoaded', function () {
        // user_num 속성만을 포함하는 배열 생성
        const userNumArray = postInfo.map(function(post) {
            return post.user_num;
        });
        console.log("배열에서 유저번호 가져오기 : "+userNumArray);

        // post_num 속성만을 포함하는 배열 생성
        const postNumArray = postInfo.map(function(post) {
            return post.post_num;
        });
        console.log("배열에서 포스트번호 가져오기 : "+postNumArray);

        var link = '/post/edit/'+ postNumArray ;
        console.log(link);

        // userNumArray와 sessionInfo 각각의 요소를 비교하여 일치하는지 확인
        const isUserInSession = userNumArray.some(function(userNum) {
            return userNum === sessionInfo.user_num;
        });

        // 조건이 맞다면 'chatButton'의 innerText를 수정하기로 변경
        if (isUserInSession) {
            document.getElementById('chatButton').innerText = "수정하기";
            document.getElementById('link').href = link;
            document.getElementById('edit').removeAttribute('disabled');
        }

    });
</script>

</body>
</html>